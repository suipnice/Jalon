var qq=qq||{};qq.FileUploader=function(e){if(this._options={element:null,action:"/server/upload",params:{},allowedExtensions:[],sizeLimit:0,onAfterSelect:function(e,t){},autoUpload:!0,simUploadLimit:2,onSubmit:function(e,t){},onComplete:function(e,t,n){},template:'<div class="qq-uploader"><div class="qq-upload-drop-area"><span>Drop files here to upload</span></div><div class="qq-upload-button">Browse for a file</div><ul class="qq-upload-list"></ul></div>',fileTemplate:'<li><a class="qq-upload-cancel" href="#">&nbsp;</a><div class="qq-upload-infos"><span class="qq-upload-file"></span><span class="qq-upload-spinner"></span><span class="qq-upload-failed-text">Failed</span></div><div class="qq-upload-size"></div></li>',classes:{button:"qq-upload-button",drop:"qq-upload-drop-area",dropActive:"qq-upload-drop-area-active",list:"qq-upload-list",file:"qq-upload-file",spinner:"qq-upload-spinner",size:"qq-upload-size",cancel:"qq-upload-cancel",success:"qq-upload-success",fail:"qq-upload-fail"},messages:{typeError:"{file} has invalid extension. Only {extensions} are allowed.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",emptyError:"{file} is empty, please select files again without it."},showMessage:function(e){alert(e)},debugMode:!1},qq.extend(this._options,e),this._element=this._options.element,1!=this._element.nodeType)throw new Error("element param of FileUploader should be dom node");base_template=this._options.template,debug_template='<div class="qq-upload-debug">  <strong>Current Uploads : </strong><span class="qq-upload-debug-curruploads"></span></div>',this._options.debugMode&&(base_template+=debug_template),this._element.innerHTML=base_template,this._filesInProgress=0,this._classes=this._options.classes,this._handler=this._createUploadHandler(),this._debugConsole=this.getDebugConsole(),this._bindCancelEvent();var t=this;this._button=new qq.UploadButton({element:this._getElement("button"),multiple:qq.UploadHandlerXhr.isSupported(),onChange:function(e){t._onInputChange(e)}}),this._setupDragDrop()},qq.FileUploader.prototype={setParams:function(e){this._options.params=e},getDebugConsole:function(){return qq.getByClass(this._element,"qq-upload-debug")[0]},logDebug:function(e,t){blocdebug=qq.getByClass(this._debugConsole,"qq-upload-debug-"+e),blocdebug&&qq.setText(blocdebug[0],t)},isUploading:function(){return!!this._filesInProgress},_getElement:function(e,t){"string"==typeof e&&(t=e,e=this._element);var n=qq.getByClass(e,this._options.classes[t])[0];if(!n)throw new Error("element not found "+t);return n},_error:function(e,t,n){var o=this._options.messages[e];if(o=o.replace("{file}",this._formatFileName(t)),o=o.replace("{extensions}",this._options.allowedExtensions.join(", ")),o=o.replace("{sizeLimit}",this._formatSize(this._options.sizeLimit)),"undefined"==typeof n)this._options.showMessage(o);else{var i=this._getItemByFileId(n),s=document.createElement("div");i.appendChild(s),eclass=document.createAttribute("class"),eclass.nodeValue="server-error",s.setAttributeNode(eclass),s.innerText=o,s.textContent=o}},_formatFileName:function(e){return e.length>33&&(e=e.slice(0,19)+"..."+e.slice(-13)),e},_isAllowedExtension:function(e){var t=-1!==e.indexOf(".")?e.replace(/.*[.]/,"").toLowerCase():"",n=this._options.allowedExtensions;if(!n.length)return!0;for(var o=0;o<n.length;o++)if(n[o].toLowerCase()==t)return!0;return!1},_setupDragDrop:function(){function e(e){var t=e.dataTransfer,n=navigator.userAgent.indexOf("AppleWebKit")>-1;return t&&(t.files||!n&&t.types.contains&&t.types.contains("Files"))}var t=this,n=this._getElement("drop");n.style.display="none";var o;qq.attach(document,"dragenter",function(e){e.preventDefault()}),qq.attach(document,"dragstart",function(e){e.dataTransfer.effectAllowed="copy",e.preventDefault()}),qq.attach(document,"dragover",function(i){e(i)&&(i.dataTransfer.dropEffect="copy",o&&clearTimeout(o),n==i.target||qq.contains(n,i.target)?(qq.addClass(n,t._classes.dropActive),i.stopPropagation()):(n.style.display="block",i.dataTransfer.dropEffect="none"),i.preventDefault())}),qq.attach(document,"dragleave",function(i){e(i)&&(n==i.target||qq.contains(n,i.target)?(qq.removeClass(n,t._classes.dropActive),i.stopPropagation()):(o&&clearTimeout(o),o=setTimeout(function(){n.style.display="none"},77)))}),qq.attach(n,"drop",function(e){n.style.display="none",t._addSelection(e.dataTransfer.files),e.preventDefault()})},_createUploadHandler:function(){var e=this,t;t=qq.UploadHandlerXhr.isSupported()?"UploadHandlerXhr":"UploadHandlerForm";var n=new qq[t]({action:this._options.action,onProgress:function(t,n,o,i){e._updateProgress(t,o,i)},onComplete:function(t,n,o){var i=e._getItemByFileId(t);qq.remove(e._getElement(i,"spinner")),o.success?(qq.remove(e._getElement(i,"cancel")),qq.addClass(i,e._classes.success)):(qq.addClass(i,e._classes.fail),o.error&&e._error(o.error,n,t)),e._filesInProgress--,e._options.onComplete(t,n,o)}});return n},_onInputChange:function(e){this._handler instanceof qq.UploadHandlerXhr?this._addSelection(e.files):this._validateFile(e)&&this._addFile(e),this._button.reset()},_addSelection:function(e){for(var t=!0,n=e.length;n--;)if(!this._validateFile(e[n])){t=!1;break}if(t)for(var n=e.length;n--;)this._addFile(e[n])},_addFile:function(e){var t=this._handler.add(e),n=this._handler.getName(t);this._options.onSubmit(t,n),this._addToList(t,n),this._options.autoUpload?this._queueUpload(t,this._options.params):this._options.onAfterSelect(e,t)},_uploadAll:function(){for(var e=this._handler._files,t=0;t<e.length;t++)e[t]&&this._queueUpload(t,this._options.params)},_queueUpload:function(e,t){var n=this._options.simUploadLimit;if(this._options.debugMode&&this.logDebug("curruploads",this._filesInProgress),this._filesInProgress<n||!n){if(this._filesInProgress++,this._handler instanceof qq.UploadHandlerXhr)var o=e;else if("number"==typeof e)var o="qq-upload-handler-iframe"+e;else var o=e;var i=this._getItemByFileId(o),s=this._getElement(i,"spinner");qq.css(s,{display:"inline-block"}),this._handler.upload(e,t)}else{var a=this;window.setTimeout(function(){a._queueUpload(e,t)},100)}},_cancelAll:function(){for(var e=this._handler._files,t=0;t<e.length;t++)e[t]&&this._handler.cancel(t)},_validateFile:function(e){var t,n;return e.value?t=e.value.replace(/.*(\/|\\)/,""):(t=null!=e.fileName?e.fileName:e.name,n=null!=e.fileSize?e.fileSize:e.size),this._isAllowedExtension(t)?0===n?(this._error("emptyError",t),!1):!(n&&this._options.sizeLimit&&n>this._options.sizeLimit)||(this._error("sizeError",t),!1):(this._error("typeError",t),!1)},_addToList:function(e,t){var n=qq.toElement(this._options.fileTemplate);n.qqFileId=e;var o=this._getElement(n,"file");qq.setText(o,this._formatFileName(t)),this._getElement("list").appendChild(n)},_updateProgress:function(e,t,n){var o=this._getItemByFileId(e),i=this._getElement(o,"size"),s,a;s=t!=n?Math.round(t/n*100):100,a="&nbsp;"+this._formatSize(n),qq.setProgressBar(i,s,a)},_formatSize:function(e){var t=-1;do e/=1024,t++;while(e>99);return Math.max(e,.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][t]},_getItemByFileId:function(e){for(var t=this._getElement("list").firstChild;t;){if(t.qqFileId==e)return t;t=t.nextSibling}},_bindCancelEvent:function(){var e=this,t=this._getElement("list");qq.attach(t,"click",function(t){t=t||window.event;var n=t.target||t.srcElement;if(qq.hasClass(n,e._classes.cancel)){qq.preventDefault(t);var o=n.parentNode;e._handler.cancel(o.qqFileId),qq.remove(o)}})}},qq.UploadButton=function(e){this._options={element:null,multiple:!1,name:"file",onChange:function(e){},hoverClass:"qq-upload-button-hover",focusClass:"qq-upload-button-focus"},qq.extend(this._options,e),this._element=this._options.element,qq.css(this._element,{position:"relative",overflow:"hidden",direction:"ltr"}),this._input=this._createInput()},qq.UploadButton.prototype={getInput:function(){return this._input},reset:function(){this._input.parentNode&&qq.remove(this._input),qq.removeClass(this._element,this._options.focusClass),this._input=this._createInput()},_createInput:function(){var e=document.createElement("input");this._options.multiple&&e.setAttribute("multiple","multiple"),e.setAttribute("type","file"),e.setAttribute("name",this._options.name),qq.css(e,{position:"absolute",right:0,top:0,fontFamily:"Arial",fontSize:"243px",margin:0,padding:0,cursor:"pointer",opacity:0}),this._element.appendChild(e);var t=this;return qq.attach(e,"change",function(){t._options.onChange(e)}),qq.attach(e,"mouseover",function(){qq.addClass(t._element,t._options.hoverClass)}),qq.attach(e,"mouseout",function(){qq.removeClass(t._element,t._options.hoverClass)}),qq.attach(e,"focus",function(){qq.addClass(t._element,t._options.focusClass)}),qq.attach(e,"blur",function(){qq.removeClass(t._element,t._options.focusClass)}),window.attachEvent&&e.setAttribute("tabIndex","-1"),e}},qq.UploadHandlerForm=function(e){this._options={action:"/upload",onComplete:function(e,t,n){}},qq.extend(this._options,e),this._inputs={},this._files=[]},qq.UploadHandlerForm.prototype={add:function(e){e.setAttribute("name","qqfile");var t=qq.getUniqueId(),n="qq-upload-handler-iframe"+t;return this._inputs[n]=e,this._files[t]=e,e.parentNode&&qq.remove(e),n},upload:function(e,t){if("number"==typeof e)var e="qq-upload-handler-iframe"+e;var n=this._inputs[e];if(!n)throw new Error("file with passed id was not added, or already uploaded or cancelled");var o=this.getName(e),i=this._createIframe(e),s=this._createForm(i,t);s.appendChild(n);var a=this;return this._attachLoadEvent(i,function(){a._options.onComplete(e,o,a._getIframeContentJSON(i)),delete a._inputs[e],uid=e.replace("qq-upload-handler-iframe",""),a._files[uid]=null,setTimeout(function(){qq.remove(i)},1)}),s.submit(),qq.remove(s),e},cancel:function(e){e in this._inputs&&(delete this._inputs[e],uid=e.replace("qq-upload-handler-iframe",""),this._files[uid]=null);var t=document.getElementById(e);t&&(t.setAttribute("src","javascript:false;"),qq.remove(t))},getName:function(e){return this._inputs[e].value.replace(/.*(\/|\\)/,"")},_attachLoadEvent:function(e,t){qq.attach(e,"load",function(){e.parentNode&&(e.contentDocument&&e.contentDocument.body&&"false"==e.contentDocument.body.innerHTML||t())})},_getIframeContentJSON:function(iframe){var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response;try{response=eval("("+doc.body.innerHTML+")")}catch(e){response={}}return response},_createIframe:function(e){var t=qq.toElement('<iframe src="javascript:false;" name="'+e+'" />');return t.setAttribute("id",e),t.style.display="none",document.body.appendChild(t),t},_createForm:function(e,t){var n=qq.toElement('<form method="post" enctype="multipart/form-data"></form>'),o="?"+qq.obj2url(t);return n.setAttribute("action",this._options.action+o),n.setAttribute("target",e.name),n.style.display="none",document.body.appendChild(n),n}},qq.UploadHandlerXhr=function(e){this._options={action:"/upload",onProgress:function(e,t,n,o){},onComplete:function(e,t,n){}},qq.extend(this._options,e),this._files=[],this._xhrs=[]},qq.UploadHandlerXhr.isSupported=function(){var e=document.createElement("input");return e.type="file","multiple"in e&&"undefined"!=typeof File&&"undefined"!=typeof(new XMLHttpRequest).upload},qq.UploadHandlerXhr.prototype={add:function(e){return this._files.push(e)-1},upload:function(id,params){var file=this._files[id],name=this.getName(id),size=this.getSize(id);if(!file)throw new Error("file with passed id was not added, or already uploaded or cancelled");var xhr=this._xhrs[id]=new XMLHttpRequest,self=this;xhr.upload.onprogress=function(e){e.lengthComputable&&self._options.onProgress(id,name,e.loaded,e.total)},xhr.onreadystatechange=function(){if(self._files[id]&&4==xhr.readyState){if(self._options.onProgress(id,name,size,size),200==xhr.status){var response;try{response=eval("("+xhr.responseText+")")}catch(e){response={}}self._options.onComplete(id,name,response)}else 500==xhr.status?xhr.responseText.indexOf("ZODB.POSException.ConflictError")>-1?self._options.onComplete(id,name,{error:"serverErrorZODBConflict"}):self._options.onComplete(id,name,{error:"serverError"}):self._options.onComplete(id,name,{});self._files[id]=null,self._xhrs[id]=null}};var queryString="?qqfile="+encodeURIComponent(name)+"&"+qq.obj2url(params);xhr.open("POST",this._options.action+queryString,!0),xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),xhr.setRequestHeader("X-File-Name",encodeURIComponent(name)),xhr.setRequestHeader("Content-Type","application/octet-stream"),xhr.send(file)},cancel:function(e){this._files[e]=null,this._xhrs[e]&&(this._xhrs[e].abort(),this._xhrs[e]=null)},getName:function(e){var t=this._files[e];return null!=t.fileName?t.fileName:t.name},getSize:function(e){var t=this._files[e];return null!=t.fileSize?t.fileSize:t.size}};var qq=qq||{};qq.extend=function(e,t){for(var n in t)e[n]=t[n]},qq.getUniqueId=function(){var e=0;return function(){return e++}}(),qq.attach=function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},qq.detach=function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.attachEvent&&e.detachEvent("on"+t,n)},qq.preventDefault=function(e){e.preventDefault?e.preventDefault():e.returnValue=!1},qq.insertBefore=function(e,t){t.parentNode.insertBefore(e,t)},qq.remove=function(e){e.parentNode.removeChild(e)},qq.contains=function(e,t){return e.contains?e.contains(t):!!(8&t.compareDocumentPosition(e))},qq.toElement=function(){var e=document.createElement("div");return function(t){e.innerHTML=t;var n=e.firstChild;return e.removeChild(n),n}}(),qq.css=function(e,t){null!=t.opacity&&"string"!=typeof e.style.opacity&&"undefined"!=typeof e.filters&&(t.filter="alpha(opacity="+Math.round(100*t.opacity)+")"),qq.extend(e.style,t)},qq.hasClass=function(e,t){var n=new RegExp("(^| )"+t+"( |$)");return n.test(e.className)},qq.addClass=function(e,t){qq.hasClass(e,t)||(e.className+=" "+t)},qq.removeClass=function(e,t){var n=new RegExp("(^| )"+t+"( |$)");e.className=e.className.replace(n," ").replace(/^\s+|\s+$/g,"")},qq.setText=function(e,t){e.innerText=t,e.textContent=t},qq.setProgressBar=function(e,t,n){if(e.hasChildNodes()){var o=qq.getByClass(e,"sizeBar")[0];o.style.width=t+"%"}else{t?size=t+"%":size="2px";var i='<div class="sizeContainer"><div class="sizeBar" style="width:'+size+'"></div></div>',s='<div class="sizeTotal">'+n+"</div>";e.innerHTML=s+i}},qq.children=function(e){for(var t=[],n=e.firstChild;n;)1==n.nodeType&&t.push(n),n=n.nextSibling;return t},qq.getByClass=function(e,t){if(e.querySelectorAll)return e.querySelectorAll("."+t);for(var n=[],o=e.getElementsByTagName("*"),i=o.length,s=0;s<i;s++)qq.hasClass(o[s],t)&&n.push(o[s]);return n},qq.obj2url=function(e,t){var n=[],o=function(e,o){var i=t?/\[\]$/.test(t)?t:t+"["+o+"]":o;n.push("object"==typeof e?qq.obj2url(e,i):"[object Function]"===Object.prototype.toString.call(e)?encodeURIComponent(i)+"="+encodeURIComponent(e()):encodeURIComponent(i)+"="+encodeURIComponent(e))};if("[object Array]"===Object.prototype.toString.call(e))for(var i=0,s=e.length;i<s;++i)o(e[i],i);else if(void 0!==e&&null!==e&&"object"==typeof e)for(var i in e)o(e[i],i);else n.push(encodeURIComponent(t)+"="+encodeURIComponent(e));return n.join("&").replace(/%20/g,"+")};var PloneQuickUpload={};PloneQuickUpload.addUploadFields=function(e,t,n,o,i,s){var a;if((i||s)&&(a=e._getItemByFileId(o),"string"==typeof o&&(o=parseInt(o.replace("qq-upload-handler-iframe","")))),s){var l=jQuery("#uploadify_label_file_description").val();jQuery(".qq-upload-cancel",a).after('                  <div class="uploadField">                      <label>'+l+'&nbsp;:&nbsp;</label>                       <textarea rows="2"                              class="file_description_field"                              id="description_'+o+'"                              name="description"                              value="" />                  </div>                   ')}if(i){var r=jQuery("#uploadify_label_file_title").val();jQuery(".qq-upload-cancel",a).after('                  <div class="uploadField">                      <label>'+r+'&nbsp;:&nbsp;</label>                       <input type="text"                              class="file_title_field"                              id="title_'+o+'"                              name="title"                              value="" />                  </div>                   ')}PloneQuickUpload.showButtons(e,t)},PloneQuickUpload.showButtons=function(e,t){var n=e._handler;return!!n._files.length&&(jQuery(".uploadifybuttons",jQuery(t).parent()).show(),"ok")},PloneQuickUpload.sendDataAndUpload=function(e,t,n){for(var o=e._handler,i=o._files,s=0,a=0;a<i.length;a++)if(i[a]){var l=jQuery(".qq-upload-list li",t)[a-s],r="";fillTitles&&(r=jQuery(".file_title_field",l).val());var u="";fillDescriptions&&(u=jQuery(".file_description_field",l).val()),e._queueUpload(a,{title:r,description:u,typeupload:n})}else s++},PloneQuickUpload.onAllUploadsComplete=function(){jQuery(document).trigger("qq-allfiles-uploaded"),Browser.onUploadComplete()},PloneQuickUpload.clearQueue=function(e,t){for(var n=e._handler,o=n._files,i=0;i<o.length;i++)o[i]&&n.cancel(i),jQuery(".qq-upload-list li",t).remove(),n._files=[],"undefined"!=typeof n._inputs&&(n._inputs={});jQuery(".uploadifybuttons").hide()},PloneQuickUpload.onUploadComplete=function(e,t,n,o,i){var s=jQuery(".qq-upload-list",t);i.success&&window.setTimeout(function(){jQuery(e._getItemByFileId(n)).remove();var t=jQuery("li",s);jQuery(document).trigger("qq-file-uploaded",i),t.length||window.setTimeout(PloneQuickUpload.onAllUploadsComplete,5)},50)},PloneQuickUpload.showUploaderViewlet=function(){jQuery(".quick-uploader").length<1&&(jQuery("form#quickuploader-viewlet").show(),jQuery(this).addClass("selected"),jQuery("form#quickuploader-viewlet").each(function(){var e=jQuery(".uploadUrl",this).val(),t=jQuery(".uploadData",this).val(),n=jQuery(this);jQuery.ajax({type:"GET",url:e,data:t,dataType:"html",contentType:"text/html; charset=utf-8",success:function(e){n.html(e)}})}))},/msie/.test(navigator.userAgent.toLowerCase())&&jQuery("#settings").remove();var Browser={};Browser.onUploadComplete=function(){window.location.reload()},jQuery(document).ready(function(){uploadAction=jQuery("#contentview-upload").find("a").removeAttr("href"),jQuery("#contentview-upload").click(PloneQuickUpload.showUploaderViewlet)});