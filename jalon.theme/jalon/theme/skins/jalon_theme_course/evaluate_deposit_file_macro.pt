<metal:macro define-macro="student_evaluate">
    <tal:condition condition="not:my_form/is_evaluable">
        <div class="panel warning radius">
            <strong>Attention :</strong> la date limite d'évaluation est dépassée, vous ne pouvez plus évaluer de devoirs.
        </div>
    </tal:condition>
    <tal:condition condition="my_form/is_evaluable">
    <h1>
        <i class="fa fa-check-square-o no-pad"></i>
        Évaluer <tal:replace replace="my_evaluate_form/deposit_name"/>
    </h1>

    <div class="panel warning radius"
         tal:condition="not:my_evaluate_form/evaluation">
        Vous n'avez aucun dépôt à évaluer.
    </div>

    <tal:condition condition="my_evaluate_form/evaluation">
    <a class="button expand radius"
       tal:attributes="href my_evaluate_form/deposit_link">
        <i class="fa fa-download"></i> Télécharger <tal:replace replace="my_evaluate_form/deposit_name"/>
    </a>

    <div class="panel alert radius"
         tal:define="error_index errors/error_index | nothing"
         tal:condition="error_index">
         <strong tal:content="error_index"/>
    </div>

    <ul class="tabs" data-tab role="tablist">
        <tal:repeat repeat="index my_evaluate_form/criteria_order">
        <li class="tab-title" role="presentation">
            <a role="tab" tabindex="0" aria-selected="true"
               tal:attributes="id string:tab${repeat/index/number};
                               href string:#criteria${repeat/index/number};
                               aria-controls string:#criteria${repeat/index/number}"
               tal:content="string:Critère ${repeat/index/number}"/>
        </li>
        </tal:repeat>
    </ul>
    <form class="peer_evaluate"
          tal:attributes="action my_evaluate_form/form_link"
          tal:define="criteria_evaluated my_evaluate_form/criteria_evaluated">
        <input type="hidden" name="form.submitted" value="1"/>
        <input type="hidden" name="mode_etudiant" value="true"/>
        <input type="hidden" name="user_id" tal:attributes="value user/getId"/>
        <input type="hidden" name="criteria_order" tal:attributes="value my_evaluate_form/criteria_order"/>
        <input type="hidden" name="deposit_id" tal:attributes="value my_evaluate_form/deposit_id"/>
        <div class="tabs-content">
            <section role="tabpanel" aria-hidden="true" class="content active">
                <div class="panel callout radius">Sélectionnez un onglet</div>
            </section>
            <tal:repeat repeat="index my_evaluate_form/criteria_order">
            <section role="tabpanel" aria-hidden="true" class="content"
                     tal:define="criteria python:my_evaluate_form['criteria_dict'][index];
                                 criteria_evaluate python:criteria_evaluated.get(index, {'criteria_comment': '', 'criteria_note': criteria['notation']});
                                 criteria_id string:criteria${repeat/index/number}"
                     tal:attributes="id criteria_id">
                <h2 tal:content="criteria/title"/>

                <div class="row">
                    <div class="small-12 columns">
                        <h3>Description :</h3>
                    </div>
                    <div class="small-12 medium-7 columns">
                        <div class="panel callout radius"
                             tal:content="structure python:criteria['description'].replace('\n', '<br/>')"/>
                    </div>
                    <div class="small-12 medium-5 columns">
                        <dl class="deflist">
                            <dt>Noter sur</dt>
                            <dd tal:content="criteria/notation" />
                            <dt>Coefficient</dt>
                            <dd tal:content="criteria/coefficient" />
                            <dt>Commentaire étudiant</dt>
                            <dd>
                                <tal:replace replace="python:my_form['comment_dict'][criteria['comment']]"/>,
                            </dd>
                            <dd>
                                entre <tal:replace replace="criteria/comment_min"/> et <tal:replace replace="criteria/comment_max"/> caractères.
                            </dd>
                        </dl>
                    </div>
                </div>

                <div tal:define="criteria_comment string:${criteria_id}-comment;
                                 error python:errors.get(criteria_comment, None);"
                     tal:attributes="id string:archetypes-fieldname-${criteria_comment};
                                     class python:context.test(error, 'error field', 'field')">
                    <tal:condition condition="python:criteria['comment'] != '0'">
                    <label tal:attributes="for criteria_comment">Commentaire</label>
                    <div class="fieldErrorBox" tal:content="error"
                         tal:condition="error"/>
                    <textarea tal:attributes="name criteria_comment;
                                              id criteria_comment;
                                              maxlength criteria/comment_max" rows="5"><tal:block replace="python:request.get(criteria_comment, criteria_evaluate['criteria_comment'])" on-error="nothing"/></textarea>
                    </tal:condition>
                    <tal:condition condition="python:criteria['comment'] == '0'">
                    <input type="hidden" value=""
                           tal:attributes="name criteria_comment"/>
                    </tal:condition>
                    <input type="hidden"
                           tal:attributes="name string:${criteria_comment}-code;
                                           value criteria/comment"/>
                    <input type="hidden"
                           tal:attributes="name string:${criteria_comment}-min;
                                           value criteria/comment_min"/>
                    <input type="hidden"
                           tal:attributes="name string:${criteria_comment}-max;
                                           value criteria/comment_max"/>
                </div>
                <div tal:define="criteria_note string:${criteria_id}-note;
                                 error python:errors.get(criteria_note, None)"
                     tal:attributes="id string:archetypes-fieldname-${criteria_note};
                                     class python:context.test(error, 'field error', 'field')">
                    <label tal:attributes="for criteria_note">
                        Nombre de points (max <tal:replace replace="criteria/notation"/>)
                    </label>
                    <div class="fieldErrorBox" tal:content="error"
                         tal:condition="error"/>
                    <input type="number" min="0" step="1" style="width:3em;display:inline;"
                           tal:define="error python:errors.get(criteria_note, None);
                                       value python:request.get(criteria_note, criteria_evaluate['criteria_note'])"
                           tal:attributes="class python:context.test(error, 'error', '');
                                           name  criteria_note;
                                           value value;
                                           max criteria/notation"/>
                    <input type="hidden"
                           tal:attributes="name string:${criteria_id};
                                           value index"/>
                    <input type="hidden"
                           tal:attributes="name string:${criteria_note}_max;
                                           value criteria/notation"/>
                </div>
                <div class="text-center"
                     tal:define="crit_number repeat/index/number;
                                 crit_prev python:'%s' % (int(crit_number) - 1);
                                 crit_next python:'%s' % (int(crit_number) + 1)">
                    <a class="button small"
                       tal:attributes="onclick string:document.getElementById('tab${crit_prev}').click();
                                       aria-controls string:#criteria${crit_prev}"
                       tal:condition="not: repeat/index/start">
                        <i class="fa fa-arrow-left"></i>
                        Précédent
                    </a>
                    <a class="button small"
                       tal:attributes="onclick string:document.getElementById('tab${crit_next}').click();
                                       aria-controls string:#criteria${crit_next}"
                       tal:condition="not: repeat/index/end">
                        <i class="fa fa-arrow-right"></i>
                        Suivant
                    </a>
                    <button type="submit" class="button small"
                            name="form.button.save"
                            tal:condition="repeat/index/end">
                        <i class="fa fa-pencil"></i>
                        <tal:block i18n:translate="">Enregistrer</tal:block>
                    </button>
                </div>
            </section>
            </tal:repeat>
        </div>
    </form>
    </tal:condition>
    </tal:condition>
</metal:macro>

<metal:macro define-macro="teacher_evaluate">
    <h1>
        <i class="fa fa-check-square-o no-pad"></i>
        Évaluation(s) du devoir de <tal:replace replace="my_evaluate_form/student_name"/>
    </h1>

    <div class="panel warning radius"
         tal:condition="not:my_evaluate_form/criteria_eval">
        Cet étudiant n'a eu aucune évaluation de ses pairs.
    </div>

    <a class="button expand radius"
       tal:attributes="href my_evaluate_form/deposit_link">
        <i class="fa fa-download"></i> Télécharger ce dépôt
    </a>

    <div class="panel alert radius"
         tal:define="error_index errors/error_index | nothing"
         tal:condition="error_index">
         <strong tal:content="error_index"/>
    </div>

    <ul class="tabs" data-tab role="tablist">
        <tal:repeat repeat="index my_evaluate_form/criteria_order">
        <li class="tab-title" role="presentation">
            <a role="tab" tabindex="0" aria-selected="true"
               tal:attributes="id string:tab${repeat/index/number};
                               href string:#criteria${repeat/index/number};
                               aria-controls string:#criteria${repeat/index/number}">
                <i class="fa fa-exclamation-triangle alert"
                   tal:condition="python:my_evaluate_form['criteria_avg'][index]['criteria_error']"></i>
                <tal:replace replace="string:Critère ${repeat/index/number}"/>
            </a>
        </li>
        </tal:repeat>
    </ul>
    <form class="peer_evaluate"
          tal:attributes="action my_evaluate_form/form_link">
        <input type="hidden" name="form.submitted" value="1"/>
        <input type="hidden" name="teacher" value="1"/>
        <input type="hidden" name="student_id" tal:attributes="value student_id"/>
        <input type="hidden" name="criteria_order" tal:attributes="value my_evaluate_form/criteria_order"/>
        <div class="tabs-content">
            <section role="tabpanel" aria-hidden="true" class="content active">
                <div class="panel callout radius">Sélectionnez un onglet</div>
            </section>
            <tal:repeat repeat="index my_evaluate_form/criteria_order">
            <section role="tabpanel" aria-hidden="true" class="content"
                     tal:define="criteria python:my_evaluate_form['criteria_dict'][index];
                                 criteria_avg python:my_evaluate_form['criteria_avg'][index];
                                 criteria_id string:criteria${repeat/index/number};
                                 evaluation_list python:my_evaluate_form['criteria_eval'].get(index, [])"
                     tal:attributes="id criteria_id">
                <h2>
                    <tal:replace replace="criteria/title"/> (coefficient : <tal:replace replace="criteria/coefficient"/>)
                </h2>
                <div class="row">
                    <div class="small-12 columns">
                        <h3>Description :</h3>
                    </div>
                    <div class="small-12 medium-7 columns">
                         <div class="panel callout radius"
                              tal:content="structure python:criteria['description'].replace('\n', '<br/>')"/>
                    </div>
                    <div class="small-12 medium-5 columns">
                        <dl class="deflist"
                            tal:define="comment_dict my_form/comment_dict">
                            <dt>Noter sur :</dt><dd tal:content="criteria/notation" />
                            <dt>Marge d'alerte :</dt><dd><tal:replace replace="criteria/gap"/> point(s)</dd>
                            <dt>Moyenne du critère :</dt><dd><strong tal:attributes="style criteria_avg/criteria_style"
                                                                     tal:content="criteria_avg/criteria_avg"/></dd>
                            <dt>Commentaire étudiant :</dt><dd><tal:replace replace="python:comment_dict[criteria['comment']]"/></dd>
                        </dl>
                    </div>
                </div>
                <div tal:condition="my_evaluate_form/has_self_evaluation">
                    <h2>
                        Auto-évaluation de <tal:replace replace="my_evaluate_form/student_name"/> (<tal:replace replace="python:my_evaluate_form['self_evaluation_dict'][index]['criteria_note']"/> / <tal:replace replace="criteria/notation"/> points)
                    </h2>
                    <div class="panel callout radius"
                         tal:define="comment python:my_evaluate_form['self_evaluation_dict'][index]['criteria_comment']"
                         tal:content="comment"
                         tal:condition="comment"/>
                </div>
                <div class="panel warning radius"
                     tal:condition="criteria_avg/criteria_error">
                     <tal:replace replace="criteria_avg/criteria_text"/>
                </div>
                <h2 tal:condition="evaluation_list">
                    Évaluation des étudiants
                </h2>
                <div tal:repeat="evaluation evaluation_list">
                    <h3 tal:attributes="style evaluation/criteria_style">
                        <i class="fa fa-exclamation-triangle alert"
                           tal:condition="evaluation/criteria_error"></i>Évaluation de <tal:replace replace="evaluation/corrected_stu"/> : <tal:replace replace="evaluation/criteria_note"/> point(s)
                    </h3>
                    <div class="panel callout radius"
                         tal:content="evaluation/criteria_comment"
                         tal:condition="evaluation/criteria_comment">
                    </div>
                </div>
                <div tal:define="criteria_comment string:${criteria_id}-comment;
                                 error python:errors.get(criteria_comment, None)"
                     tal:attributes="id string:archetypes-fieldname-${criteria_comment};
                                     class python:context.test(error, 'error field', 'field')">
                    <label tal:attributes="for criteria_comment">Commentaire</label>
                    <div class="fieldErrorBox" tal:content="error"
                         tal:condition="error"/>
                    <textarea tal:attributes="name criteria_comment; id criteria_comment" rows="5"><tal:block replace="python:request.get(criteria_comment, criteria_avg['criteria_comment'])"/></textarea>
                </div>
                <div tal:define="criteria_note string:${criteria_id}-note;
                                 error python:errors.get(criteria_note, None)"
                     tal:attributes="id string:archetypes-fieldname-${criteria_note};
                                     class python:context.test(error, 'field error', 'field')">
                    <label tal:attributes="for criteria_note">
                        Nombre de points (max <tal:replace replace="criteria/notation"/>)
                    </label>
                    <div class="fieldErrorBox" tal:content="error"
                         tal:condition="error"/>
                    <input type="number" min="1" step="1" style="width:3em;display:inline;"
                           tal:define="error python:errors.get(criteria_note, None)"
                           tal:attributes="class python:context.test(error, 'error', '');
                                           name  criteria_note;
                                           value python:request.get(criteria_note, int(criteria_avg['criteria_avg']));
                                           max criteria/notation"/>
                    <input type="hidden"
                           tal:attributes="name string:${criteria_id};
                                           value index"/>
                    <input type="hidden"
                           tal:attributes="name string:${criteria_note}_max;
                                           value criteria/notation"/>
                </div>
                <div class="text-center"
                     tal:define="crit_number repeat/index/number;
                                 crit_prev python:'%s' % (int(crit_number) - 1);
                                 crit_next python:'%s' % (int(crit_number) + 1)">
                    <a class="button small"
                       tal:attributes="onclick string:document.getElementById('tab${crit_prev}').click();
                                       aria-controls string:#criteria${crit_prev}"
                       tal:condition="not: repeat/index/start">
                        <i class="fa fa-arrow-left"></i>
                        Précédent
                    </a>
                    <a class="button small"
                       tal:attributes="onclick string:document.getElementById('tab${crit_next}').click();
                                       aria-controls string:#criteria${crit_next}"
                       tal:condition="not: repeat/index/end">
                        <i class="fa fa-arrow-right"></i>
                        Suivant
                    </a>
                    <button type="submit" class="button small"
                            name="form.button.save"
                            tal:condition="repeat/index/end">
                        <i class="fa fa-pencil"></i>
                        <tal:block i18n:translate="">Enregistrer</tal:block>
                    </button>
                </div>
            </section>
            </tal:repeat>
        </div>
    </form>
</metal:macro>
