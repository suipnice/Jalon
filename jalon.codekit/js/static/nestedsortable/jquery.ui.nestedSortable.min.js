!function($){function e(e,t,s){return e>t&&t+s>e}$.widget("mjs.nestedSortable",$.extend({},$.ui.sortable.prototype,{options:{doNotClear:!1,expandOnHover:700,isAllowed:function(e,t,s){return!0},isTree:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,startCollapsed:!1,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf"},_create:function(){if(this.element.data("ui-sortable",this.element.data("mjs-nestedSortable")),!this.element.is(this.options.listType))throw new Error("nestedSortable: Please check that the listType option is set to your actual list type");if(this.options.isTree&&this.options.expandOnHover&&(this.options.tolerance="intersect"),$.ui.sortable.prototype._create.apply(this,arguments),this.options.isTree){var e=this;$(this.items).each(function(){var t=this.item;t.children(e.options.listType).length?(t.addClass(e.options.branchClass),t.addClass(e.options.startCollapsed?e.options.collapsedClass:e.options.expandedClass)):t.addClass(e.options.leafClass)})}},_destroy:function(){return this.element.removeData("mjs-nestedSortable").removeData("ui-sortable"),$.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(e){var t,s,i,o,l=this.options,r=!1;this.position=this._generatePosition(e),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-e.pageY<l.scrollSensitivity?this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop+l.scrollSpeed:e.pageY-this.overflowOffset.top<l.scrollSensitivity&&(this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop-l.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-e.pageX<l.scrollSensitivity?this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft+l.scrollSpeed:e.pageX-this.overflowOffset.left<l.scrollSensitivity&&(this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft-l.scrollSpeed)):(e.pageY-$(document).scrollTop()<l.scrollSensitivity?r=$(document).scrollTop($(document).scrollTop()-l.scrollSpeed):$(window).height()-(e.pageY-$(document).scrollTop())<l.scrollSensitivity&&(r=$(document).scrollTop($(document).scrollTop()+l.scrollSpeed)),e.pageX-$(document).scrollLeft()<l.scrollSensitivity?r=$(document).scrollLeft($(document).scrollLeft()-l.scrollSpeed):$(window).width()-(e.pageX-$(document).scrollLeft())<l.scrollSensitivity&&(r=$(document).scrollLeft($(document).scrollLeft()+l.scrollSpeed))),r!==!1&&$.ui.ddmanager&&!l.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,e)),this.positionAbs=this._convertPositionTo("absolute");var n=this.placeholder.offset().top;this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),this.hovering=this.hovering?this.hovering:null,this.mouseentered=this.mouseentered?this.mouseentered:!1;var a=this.placeholder[0].parentNode.parentNode&&$(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?$(this.placeholder[0].parentNode.parentNode):null,h=this._getLevel(this.placeholder),p=this._getChildLevels(this.helper),d=document.createElement(l.listType);for(t=this.items.length-1;t>=0;t--)if(s=this.items[t],i=s.item[0],o=this._intersectsWithPointer(s),o&&s.instance===this.currentContainer&&i!==this.currentItem[0]&&this.placeholder[1===o?"next":"prev"]()[0]!==i&&!$.contains(this.placeholder[0],i)&&("semi-dynamic"===this.options.type?!$.contains(this.element[0],i):!0)){if(this.mouseentered||($(i).mouseenter(),this.mouseentered=!0),l.isTree&&$(i).hasClass(l.collapsedClass)&&l.expandOnHover&&!this.hovering){$(i).addClass(l.hoveringClass);var c=this;this.hovering=window.setTimeout(function(){$(i).removeClass(l.collapsedClass).addClass(l.expandedClass),c.refreshPositions(),c._trigger("expand",e,c._uiHash())},l.expandOnHover)}if(this.direction=1==o?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(s))break;if($(i).mouseleave(),this.mouseentered=!1,$(i).removeClass(l.hoveringClass),this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,!l.protectRoot||this.currentItem[0].parentNode==this.element[0]&&i.parentNode!=this.element[0])l.protectRoot||this._rearrange(e,s);else if(this.currentItem[0].parentNode!=this.element[0]&&i.parentNode==this.element[0]){$(i).children(l.listType).length||(i.appendChild(d),l.isTree&&$(i).removeClass(l.leafClass).addClass(l.branchClass+" "+l.expandedClass));var u="down"===this.direction?$(i).prev().children(l.listType):$(i).children(l.listType);void 0!==u[0]&&this._rearrange(e,null,u)}else this._rearrange(e,s);this._clearEmpty(i),this._trigger("change",e,this._uiHash());break}var m=this.placeholder[0].previousSibling?$(this.placeholder[0].previousSibling):null;if(null!=m)for(;"li"!=m[0].nodeName.toLowerCase()||m[0]==this.currentItem[0]||m[0]==this.helper[0];){if(!m[0].previousSibling){m=null;break}m=$(m[0].previousSibling)}var f=this.placeholder[0].nextSibling?$(this.placeholder[0].nextSibling):null;if(null!=f)for(;"li"!=f[0].nodeName.toLowerCase()||f[0]==this.currentItem[0]||f[0]==this.helper[0];){if(!f[0].nextSibling){f=null;break}f=$(f[0].nextSibling)}return this.beyondMaxLevels=0,null==a||null!=f||l.protectRoot&&a[0].parentNode==this.element[0]||!(l.rtl&&this.positionAbs.left+this.helper.outerWidth()>a.offset().left+a.outerWidth()||!l.rtl&&this.positionAbs.left<a.offset().left)?null==m||m.hasClass(l.disableNestingClass)||!(m.children(l.listType).length&&m.children(l.listType).is(":visible")||!m.children(l.listType).length)||l.protectRoot&&this.currentItem[0].parentNode==this.element[0]||!(l.rtl&&this.positionAbs.left+this.helper.outerWidth()<m.offset().left+m.outerWidth()-l.tabSize||!l.rtl&&this.positionAbs.left>m.offset().left+l.tabSize)?this._isAllowed(a,h,h+p):(this._isAllowed(m,h,h+p+1),m.children(l.listType).length||(m[0].appendChild(d),l.isTree&&m.removeClass(l.leafClass).addClass(l.branchClass+" "+l.expandedClass)),n&&n<=m.offset().top?m.children(l.listType).prepend(this.placeholder):m.children(l.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",e,this._uiHash())):(a.after(this.placeholder[0]),l.isTree&&a.children(l.listItem).children("li:visible:not(.ui-sortable-helper)").length<1&&a.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass),this._clearEmpty(a[0]),this._trigger("change",e,this._uiHash())),this._contactContainers(e),$.ui.ddmanager&&$.ui.ddmanager.drag(this,e),this._trigger("sort",e,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(e,t){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?$(this.domPosition.prev).after(this.placeholder):$(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",e,this._uiHash())),$("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass),this.mouseentered=!1,this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,$.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(t){var s=this.options.isTree?.8:.5,i=e(this.positionAbs.top+this.offset.click.top,t.top+t.height*s,t.height),o=e(this.positionAbs.top+this.offset.click.top,t.top-t.height*s,t.height),l=e(this.positionAbs.left+this.offset.click.left,t.left+t.width/2,t.width),r=this._getDragVerticalDirection(),n=this._getDragHorizontalDirection();return this.floating&&n?"right"==n&&l||"left"==n&&!l:r&&("down"==r&&i||"up"==r&&o)},_contactContainers:function(e){this.options.protectRoot&&this.currentItem[0].parentNode==this.element[0]||$.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(e,t){$.ui.sortable.prototype._clear.apply(this,arguments);for(var s=this.items.length-1;s>=0;s--){var i=this.items[s].item[0];this._clearEmpty(i)}},serialize:function(e){var t=$.extend({},this.options,e),s=this._getItemsAsjQuery(t&&t.connected),i=[];return $(s).each(function(){var e=($(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/),s=($(t.item||this).parent(t.listType).parent(t.items).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);e&&i.push((t.key||e[1])+"["+(t.key&&t.expression?e[1]:e[2])+"]="+(s?t.key&&t.expression?s[1]:s[2]:t.rootID))}),!i.length&&t.key&&i.push(t.key+"="),i.join("&")},toHierarchy:function(e){function t(e){var i=($(e).attr(s.attribute||"id")||"").match(s.expression||/(.+)[-=_](.+)/);if(i){var o={id:i[2]};return $(e).children(s.listType).children(s.items).length>0&&(o.children=[],$(e).children(s.listType).children(s.items).each(function(){var e=t(this);o.children.push(e)})),o}}var s=$.extend({},this.options,e),i=s.startDepthCount||0,o=[];return $(this.element).children(s.items).each(function(){var e=t(this);o.push(e)}),o},toArray:function(e){function t(e,l,r){var n=r+1,a,h;if($(e).children(s.listType).children(s.items).length>0&&(l++,$(e).children(s.listType).children(s.items).each(function(){n=t($(this),l,n)}),l--),a=$(e).attr(s.attribute||"id").match(s.expression||/(.+)[-=_](.+)/),l===i+1)h=s.rootID;else{var p=$(e).parent(s.listType).parent(s.items).attr(s.attribute||"id").match(s.expression||/(.+)[-=_](.+)/);h=p[2]}return a&&o.push({item_id:a[2],parent_id:h,depth:l,left:r,right:n}),r=n+1}var s=$.extend({},this.options,e),i=s.startDepthCount||0,o=[],l=1;return s.excludeRoot||(o.push({item_id:s.rootID,parent_id:null,depth:i,left:l,right:2*($(s.items,this.element).length+1)}),l++),$(this.element).children(s.items).each(function(){l=t(this,i+1,l)}),o=o.sort(function(e,t){return e.left-t.left})},_clearEmpty:function(e){var t=this.options,s=$(e).children(t.listType);!s.length||s.children().length||t.doNotClear?t.isTree&&s.length&&s.children().length&&s.is(":visible")?$(e).removeClass(t.leafClass).addClass(t.branchClass+" "+t.expandedClass):t.isTree&&s.length&&s.children().length&&!s.is(":visible")&&$(e).removeClass(t.leafClass).addClass(t.branchClass+" "+t.collapsedClass):(t.isTree&&$(e).removeClass(t.branchClass+" "+t.expandedClass).addClass(t.leafClass),s.remove())},_getLevel:function(e){var t=1;if(this.options.listType)for(var s=e.closest(this.options.listType);s&&s.length>0&&!s.is(".ui-sortable");)t++,s=s.parent().closest(this.options.listType);return t},_getChildLevels:function(e,t){var s=this,i=this.options,o=0;return t=t||0,$(e).children(i.listType).children(i.items).each(function(e,i){o=Math.max(s._getChildLevels(i,t+1),o)}),t?o+1:o},_isAllowed:function(e,t,s){var i=this.options,o=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");i.isAllowed(this.placeholder,e,this.currentItem)?s>o&&0!=o?(this.placeholder.addClass(i.errorClass),this.beyondMaxLevels=s-o):(this.placeholder.removeClass(i.errorClass),this.beyondMaxLevels=0):(this.placeholder.addClass(i.errorClass),this.beyondMaxLevels=s>o&&0!=o?s-o:1)}})),$.mjs.nestedSortable.prototype.options=$.extend({},$.ui.sortable.prototype.options,$.mjs.nestedSortable.prototype.options)}(jQuery);